name: Release manuscripts-share

# Trigger by pushing a tag like: git tag share-v1.1 && git push origin share-v1.1
on:
  push:
    tags:
      - 'share-v*'

jobs:
  build-mac:
    name: Build (macOS)
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Build app
        run: |
          cd manuscripts-share
          pip install --quiet pyinstaller aiohttp zeroconf pystray Pillow pyobjc
          python make_icons.py
          pyinstaller --onedir --windowed \
            --name "manuscripts share" \
            --icon icon.icns \
            --collect-all zeroconf \
            --collect-all aiohttp \
            --collect-all pystray \
            --hidden-import pystray._darwin \
            --hidden-import tkinter \
            --add-data "JetBrainsMono-Regular.ttf:." \
            --add-data "JetBrainsMono-Light.ttf:." \
            share.py
      - name: Package DMG
        run: |
          TAG="${GITHUB_REF_NAME}"
          VERSION="${TAG#share-v}"
          DMG="manuscripts-share-mac-v${VERSION}.dmg"
          mkdir manuscripts-share/dist/dmg-staging
          cp -r "manuscripts-share/dist/manuscripts share.app" "manuscripts-share/dist/dmg-staging/"
          ln -s /Applications "manuscripts-share/dist/dmg-staging/Applications"
          hdiutil create \
            -volname "manuscripts share" \
            -srcfolder "manuscripts-share/dist/dmg-staging" \
            -ov \
            -format UDZO \
            "manuscripts-share/dist/${DMG}"
          echo "ASSET=manuscripts-share/dist/${DMG}" >> "$GITHUB_ENV"
      - uses: actions/upload-artifact@v4
        with:
          name: mac-build
          path: ${{ env.ASSET }}

  build-windows:
    name: Build (Windows)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Build binary
        run: |
          cd manuscripts-share
          pip install --quiet pyinstaller aiohttp zeroconf pystray Pillow pywin32
          python make_icons.py
          pyinstaller --onefile --noconsole `
            "--name" "manuscripts share" `
            --icon icon.ico `
            --collect-all zeroconf `
            --collect-all aiohttp `
            --collect-all pystray `
            --hidden-import pystray._win32 `
            --hidden-import tkinter `
            "--add-data" "JetBrainsMono-Regular.ttf;." `
            "--add-data" "JetBrainsMono-Light.ttf;." `
            share.py
      - uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: "manuscripts-share/dist/manuscripts share.exe"

  release:
    name: Create GitHub Release
    needs: [build-mac, build-windows]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
      - name: Publish release
        uses: softprops/action-gh-release@v2
        with:
          name: manuscripts-share ${{ github.ref_name }}
          body: |
            ## manuscripts-share ${{ github.ref_name }}

            **macOS**: open the DMG, drag `manuscripts-share` to Applications
            *(first run: right-click → Open to bypass Gatekeeper)*

            **Windows**: double-click `manuscripts-share.exe`
            *(first run: click "More info" → "Run anyway" to bypass SmartScreen)*

            A setup dialog will appear on first launch to set your name and password.
            The app then runs in the system tray — look for the gold icon.
          files: |
            artifacts/mac-build/*.dmg
            artifacts/windows-build/manuscripts share.exe
